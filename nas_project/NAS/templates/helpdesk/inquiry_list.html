<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>お問い合わせ一覧 - NASシステム</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f6fa;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #4a90e2;
      color: white;
      padding: 15px 20px;
      width: 100%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
      z-index: 20;
      box-sizing: border-box;
    }

    .menu-icon {
      cursor: pointer; user-select: none; padding: 5px;
      width: 30px; height: 22px; position: relative; z-index: 21;
    }
    .menu-icon span {
      display: block; position: absolute; width: 100%; height: 3px;
      background-color: white; border-radius: 3px;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .menu-icon span:nth-child(1) { top: 0; }
    .menu-icon span:nth-child(2) { top: 9.5px; }
    .menu-icon span:nth-child(3) { top: 19px; }
    .menu-icon.active span:nth-child(1) { top: 9.5px; transform: rotate(45deg); }
    .menu-icon.active span:nth-child(2) { opacity: 0; }
    .menu-icon.active span:nth-child(3) { top: 9.5px; transform: rotate(-45deg); }

    .title {
      font-size: 22px; font-weight: bold; text-align: center;
      flex-grow: 1; margin-left: 60px;
    }

    .logout-btn {
      background-color: white; color: #4a90e2; border: none;
      padding: 8px 15px; border-radius: 6px; font-size: 14px;
      font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    .logout-btn:hover { background-color: #e3efff; }

    .side-menu {
      position: absolute; top: 60px; left: 0; width: 230px;
      background-color: white; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      border-top: 1px solid #e0e0e0; display: none;
      flex-direction: column; z-index: 10;
    }
    .side-menu a {
      padding: 15px 20px; text-decoration: none; color: #333;
      border-bottom: 1px solid #eee; transition: 0.2s;
    }
    .side-menu a:hover { background-color: #f0f6ff; color: #4a90e2; }

    .content {
      width: 90%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      box-sizing: border-box;
    }

    .top-bar {
      display: flex;
      justify-content: flex-start;
      width: 100%;
      margin-bottom: 20px;
    }

    .back-button {
      background-color: #f1f1f1; border: 1px solid #ccc; padding: 8px 16px;
      border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s;
    }
    .back-button:hover { background-color: #e0e0e0; }

    h2 {
      width: 100%;
      text-align: center;
      color: #333;
    }

    .controls-area {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .search-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-area input[type="text"] {
      padding: 8px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    .search-button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      background-color: #007bff;
      color: white;
      transition: 0.2s;
    }
    .search-button:hover { background-color: #0069d9; }

    .sort-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sort-area label { font-size: 14px; color: #555; }

    .sort-area select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background-color: white;
    }

    .list-header {
      width: 100%;
      margin-bottom: 10px;
      display: flex;
      justify-content: flex-end;
    }

    #totalCount {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    #tableContainer {
      width: 100%;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      font-size: 14px;
    }

    th, td {
      text-align: left;
      padding: 14px 18px;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }

    th {
      background-color: #007bff;
      color: white;
      font-size: 15px;
    }

    tbody tr:hover {
      background-color: #f1f1f1;
      cursor: pointer;
    }

    .status-badge {
      font-size: 12px;
      font-weight: bold;
      padding: 5px 12px;
      border-radius: 15px;
      color: white;
      white-space: nowrap;
    }
    .status-unhandled { background-color: #dc3545; }
    .status-handling { background-color: #ffc107; color: #333; }
    .status-solved { background-color: #28a745; }

    .no-data td {
      text-align: center;
      color: #777;
      padding: 40px;
      font-size: 16px;
      cursor: default !important;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 30px;
      gap: 8px;
    }

    .pagination button {
      border: 1px solid #ccc;
      background-color: white;
      color: #007bff;
      padding: 8px 14px;
      cursor: pointer;
      transition: 0.2s;
      border-radius: 6px;
      font-size: 14px;
    }

    .pagination button:hover { background-color: #f0f6ff; }

    .pagination button.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }

    .pagination button.disabled {
      color: #aaa;
      cursor: not-allowed;
      background-color: #f9f9f9;
    }
    .pagination button.disabled:hover { background-color: #f9f9f9; }

  </style>
</head>
<body>
{% include 'common/admin_header.html' %}
  

  <div class="content">
    <div class="top-bar">
      <button class="back-button" onclick="location.href='{% url 'custom_admin:admin_home' %}'">← 戻る</button>
    </div>

    <h2>お問い合わせ一覧</h2>

    <div class="controls-area">
      <div class="search-area">
        <input type="text" id="searchInput" placeholder="利用者IDで検索">
        <button class="search-button" onclick="filterAndSort()">検索</button>
      </div>
      <div class="sort-area">
        <label for="sortSelect">並び替え:</label>
        <select id="sortSelect" onchange="filterAndSort()">
          <option value="new">新しい順</option>
          <option value="unhandled">未対応</option>
          <option value="handling">対応中</option>
          <option value="solved">解決済み</option>
          <option value="old">古い順</option>
          <option value="user">利用者順</option>
        </select>
      </div>
    </div>

    <div class="list-header">
      <div id="totalCount">該当件数: 0 件</div>
    </div>

    <div id="tableContainer">
    </div>

    <div class="pagination" id="paginationContainer">
    </div>

  </div>

  <script>

  document.addEventListener('DOMContentLoaded', async () => {
    await loadInquiries();
  });

  let allContacts = [];
  let currentContacts = [];
  let currentPage = 1;
  const itemsPerPage = 5;

  async function loadInquiries() {
    try {
        const response = await fetch(`/helpdesk/api/inquiries/`);  // ✅ 一覧用の正しいAPI
        if (!response.ok) throw new Error('サーバーエラー');
        const data = await response.json();

        // Djangoの InquiryService が返す JSON構造に合わせて変換
        const inquiries = data.inquiries || [];

        allContacts = inquiries.map(entry => ({
            contactId: entry.inquiryID,
            id: entry.userID || "不明",
            subject: entry.inquiryname,
            date: entry.time,
            dateObj: new Date(entry.time),
            status: entry.status || '未対応'
        }));

        filterAndSort();
    } catch (err) {
        console.error('問い合わせデータの取得エラー:', err);
        alert('データを読み込めませんでした');
    }
  }


  function filterAndSort() {
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      const sortValue = document.getElementById('sortSelect').value;

      let filteredData = allContacts.filter(c => c.id.toLowerCase().includes(searchTerm));

      if (sortValue === 'unhandled') {
          filteredData = filteredData.filter(c => c.status === '未対応');
      } else if (sortValue === 'handling') {
          filteredData = filteredData.filter(c => c.status === '対応中');
      } else if (sortValue === 'solved') {
          filteredData = filteredData.filter(c => c.status === '解決済み');
      }

      switch (sortValue) {
          case 'new': filteredData.sort((a,b)=>b.dateObj-a.dateObj); break;
          case 'old': filteredData.sort((a,b)=>a.dateObj-b.dateObj); break;
          case 'user': filteredData.sort((a,b)=>a.id.localeCompare(b.id)); break;
      }

      currentContacts = filteredData;
      currentPage = 1;

      document.getElementById('totalCount').textContent = `該当件数: ${currentContacts.length} 件`;
      renderList();
      renderPagination();
  }

  function renderList() {
      const container = document.getElementById('tableContainer');
      container.innerHTML = "";

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>利用者ID</th>
            <th>お問い合わせID</th>
            <th>お問い合わせ名</th>
            <th>更新日時</th>
            <th>状態</th>
          </tr>
        </thead>
      `;

      const tbody = document.createElement('tbody');

      if (currentContacts.length === 0) {
          tbody.innerHTML = `<tr class="no-data"><td colspan="5">該当するお問い合わせはありません</td></tr>`;
      } else {
          const start = (currentPage - 1) * itemsPerPage;
          const end = start + itemsPerPage;

          currentContacts.slice(start, end).forEach(contact => {
              const tr = document.createElement('tr');
              const localDate = new Date(contact.date).toLocaleString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

              let statusClass = '';
              if (contact.status === '未対応') statusClass = 'status-unhandled';
              if (contact.status === '対応中') statusClass = 'status-handling';
              if (contact.status === '解決済み') statusClass = 'status-solved';

              tr.innerHTML = `
                <td>${contact.id}</td>
                <td>${contact.contactId}</td>
                <td>${contact.subject}</td>
                <td>${localDate}</td>
                <td><span class="status-badge ${statusClass}">${contact.status}</span></td>
              `;

              tr.onclick = () => {
                  location.href = `/helpdesk/detail/${contact.id}/${contact.contactId}/`;
              };

              tbody.appendChild(tr);
          });
      }

      table.appendChild(tbody);
      container.appendChild(table);
  }

  function renderPagination() {
      const container = document.getElementById('paginationContainer');
      container.innerHTML = "";
      const totalPages = Math.ceil(currentContacts.length / itemsPerPage);
      if (totalPages <= 1) return;

      const createButton = (text, page, disabled = false, active = false) => {
          const btn = document.createElement('button');
          btn.innerHTML = text;
          if (disabled) btn.classList.add('disabled');
          if (active) btn.classList.add('active');
          if (!disabled) btn.onclick = () => changePage(page);
          return btn;
      };

      container.appendChild(createButton('&lt;', 'prev', currentPage === 1));
      for (let i = 1; i <= totalPages; i++) {
          container.appendChild(createButton(i, i, false, currentPage === i));
      }
      container.appendChild(createButton('&gt;', 'next', currentPage === totalPages));
  }

  function changePage(page) {
      const totalPages = Math.ceil(currentContacts.length / itemsPerPage);
      if (page === 'prev' && currentPage > 1) currentPage--;
      else if (page === 'next' && currentPage < totalPages) currentPage++;
      else if (typeof page === 'number') currentPage = page;
      renderList();
      renderPagination();
  }
  </script>

</body>
</html>