{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Ç¢„ÇØ„Çª„Çπ„É≠„Ç∞ - NAS„Ç∑„Çπ„ÉÜ„É†</title>
  <style> 
  body { 
    font-family: "Segoe UI", sans-serif;
    background-color: #f5f6fa;
    margin: 0; display: flex; 
    flex-direction: column; 
    align-items: center; 
    min-height: 100vh; 
    } 
    header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      background-color: #4a90e2; 
      color: white; 
      padding: 15px 20px; 
      width: 100%; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
      position: relative; 
      z-index: 20; 
      box-sizing: border-box; 
      } 
      .menu-icon { 
        cursor: pointer; 
        user-select: none; 
        padding: 5px; 
        width: 30px; 
        height: 22px; 
        position: relative; 
        z-index: 21; 
        } 
        .menu-icon span { 
          display: block; 
          position: absolute; 
          width: 100%; 
          height: 3px; 
          background-color: white; 
          border-radius: 3px; 
          transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
          } 
          .menu-icon span:nth-child(1) { 
            top: 0; 
          } 
          .menu-icon span:nth-child(2) { 
            top: 9.5px; 
          } 
          .menu-icon span:nth-child(3) { 
            top: 19px; 
          } 
          .menu-icon.active span:nth-child(1) { 
            top: 9.5px; 
            transform: rotate(45deg); 
          } 
          .menu-icon.active span:nth-child(2) { 
            opacity: 0; } .menu-icon.active span:nth-child(3) { top: 9.5px; transform: rotate(-45deg); } .title { font-size: 22px; font-weight: bold; text-align: center; flex-grow: 1; margin-left: 60px; } .logout-btn { background-color: white; color: #4a90e2; border: none; padding: 8px 15px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s; } .logout-btn:hover { background-color: #e3efff; } .side-menu { position: absolute; top: 60px; left: 0; width: 230px; background-color: white; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); border-top: 1px solid #e0e0e0; display: none; flex-direction: column; z-index: 10; } .side-menu a { padding: 15px 20px; text-decoration: none; color: #333; border-bottom: 1px solid #eee; transition: 0.2s; } .side-menu a:hover { background-color: #f0f6ff; color: #4a90e2; } .content { width: 90%; max-width: 1200px; display: flex; flex-direction: column; align-items: center; padding: 20px 0; box-sizing: border-box; } .top-bar { display: flex; justify-content: flex-start; width: 100%; margin-bottom: 20px; } .back-button { background-color: #f1f1f1; border: 1px solid #ccc; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s; } .back-button:hover { background-color: #e0e0e0; } .controls-area { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 25px; gap: 15px; } .search-area, .filter-area { display: flex; align-items: flex-end; gap: 10px; flex-wrap: wrap; } .search-area { justify-content: center; width: auto; } .filter-area { justify-content: center; width: auto; } .control-group label { font-size: 13px; color: #555; margin-right: 5px; white-space: nowrap; margin-bottom: 3px; display: block; } .control-group-inline label { display: inline-block; margin-bottom: 0; } .control-group input[type="text"], .control-group input[type="date"], .control-group input[type="time"] { padding: 7px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; font-family: "Segoe UI", sans-serif; box-sizing: border-box; height: 34px; } .control-group input[type="text"] { width: 200px; } .control-group input[type="date"] { width: 130px; } .control-group input[type="time"] { width: 100px; } .control-button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; height: 34px; box-sizing: border-box; margin-left: 5px; } .search-button { background-color: #6c757d; } .search-button:hover { background-color: #5a6268; } .filter-button { background-color: #007bff; } .filter-button:hover { background-color: #0069d9; } .list-header { width: 100%; margin-bottom: 10px; display: flex; justify-content: flex-end; padding: 0 5px; } #totalCount { font-size: 16px; font-weight: bold; color: #333; } #tableContainer { width: 100%; } table { border-collapse: collapse; width: 100%; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); font-size: 14px; } th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #ddd; vertical-align: middle; white-space: nowrap; } th { background-color: #4a90e2; color: white; font-size: 15px;} tbody tr:hover { background-color: #f1f1f1; } .no-data td { text-align: center; color: #777; padding: 40px; font-size: 16px; } .pagination { display: flex; justify-content: center; align-items: center; margin-top: 30px; gap: 5px; } .pagination button, .pagination span { border: none; background-color: transparent; color: #007bff; padding: 6px 10px; cursor: pointer; transition: 0.2s; border-radius: 4px; font-size: 15px; min-width: 30px; text-align: center; user-select: none; } .pagination span { cursor: default; color: #6c757d; } .pagination button:hover { background-color: #e9ecef; color: #0056b3; } .pagination button.active { font-weight: bold; color: #333; background-color: #e0e0e0; cursor: default; } .pagination button.disabled { color: #ccc; cursor: not-allowed; background-color: transparent; } .pagination button.disabled:hover { background-color: transparent; color: #ccc; } .pagination button.arrow { font-weight: bold; font-size: 18px; } </style>
</head>
<body>
{% include 'common/admin_header.html' %}

  <div class="content">
    <div class="top-bar">
      <button class="back-button" onclick="location.href='{% url 'custom_admin:admin_home' %}'">‚Üê Êàª„Çã</button>
    </div>

    <div class="controls-area">
      <div class="search-area control-group control-group-inline">
        <label for="searchInput">Âà©Áî®ËÄÖID:</label>
        <input type="text" id="searchInput" placeholder="ID„ÅßÊ§úÁ¥¢">
        <button class="control-button search-button" onclick="filterLogs()">Ê§úÁ¥¢</button>
      </div>
      <div class="filter-area">
         <div class="control-group">
           <label for="dateInput">Êó•‰ªò:</label>
           <input type="date" id="dateInput">
         </div>
         <div class="control-group">
           <label for="startTimeInput">ÈñãÂßã:</label>
           <input type="time" id="startTimeInput">
         </div>
         <div class="control-group">
           <label for="endTimeInput">ÁµÇ‰∫Ü:</label>
           <input type="time" id="endTimeInput">
         </div>
         <button class="control-button filter-button" onclick="filterLogs()">Ê±∫ÂÆö</button>
      </div>
    </div>

    <div class="list-header">
      <div id="totalCount">Ë©≤ÂΩì‰ª∂Êï∞: 0 ‰ª∂</div>
    </div>

    <div id="tableContainer"></div>
    <div class="pagination" id="paginationContainer"></div>

  </div>

  <script>
    let allLogs = []; 
    let currentLogs = []; 
    let currentPage = 1;
    const itemsPerPage = 15;

    document.addEventListener('DOMContentLoaded', async () => {
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´DB„Åã„Çâ„É≠„Ç∞„ÇíË™≠„ÅøËæº„ÇÄ
        await loadLogsFromDB();
    });

    /**
     * DB„Åã„Çâ„É≠„Ç∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞ (APIÁµåÁî±)
     */
    async function loadLogsFromDB() {
      document.getElementById('tableContainer').innerHTML = `<p style="text-align:center;">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>`;
    
      try {
          // üí° custom_admin„Ç¢„Éó„É™„ÅÆAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÂëº„Å≥Âá∫„Åó
          const response = await fetch("{% url 'custom_admin:access_log_data_api' %}");
        
          if (!response.ok) {
              throw new Error(`„É≠„Ç∞„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (${response.status})`);
          }
        
          const data = await response.json();

          // „É≠„Ç∞„ÅÆÂ§âÊèõ„Å®ÂàùÊúü„ÇΩ„Éº„Éà
          allLogs = data.map(log => {
              return {
                  // JavaScript„Åß„ÅÆÊØîËºÉ„ÅÆ„Åü„ÇÅ„Å´Date„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†
                  dateTime: new Date(log.timestamp), 
                  user_id: log.user_id,
                  action: log.action,
                  timestamp: log.timestamp // ISOÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅ
              };
          })
          // ÈôçÈ†ÜÔºàÊñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„Åå‰∏äÔºâ„Å´„ÇΩ„Éº„Éà
          .sort((a, b) => b.dateTime.getTime() - a.dateTime.getTime());
        
          // ÂàùÂõû„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ (ÂÖ®„É≠„Ç∞Ë°®Á§∫)
          filterLogs(); 

      } catch (err) {
          console.error('Error loading logs:', err);
          allLogs = [];
          currentLogs = [];
          document.getElementById('totalCount').textContent = `Ë©≤ÂΩì‰ª∂Êï∞: 0 ‰ª∂`;
          document.getElementById('tableContainer').innerHTML = `
            <div style="color:#d9534f; font-weight:bold; text-align:center; margin-top:30px;">
              „É≠„Ç∞„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇË©≥Á¥∞: ${err.message}
            </div>`;
      }
    }
    
    /**
     * „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÇíÂÆüË°å„Åô„ÇãÈñ¢Êï∞
     */
    function filterLogs() {
        const searchInput = document.getElementById('searchInput');
        const dateInput = document.getElementById('dateInput');
        const startTimeInput = document.getElementById('startTimeInput');
        const endTimeInput = document.getElementById('endTimeInput');

        const searchTerm = searchInput.value.trim().toLowerCase();
        const dateValue = dateInput.value;
        const startTimeValue = startTimeInput.value;
        const endTimeValue = endTimeInput.value;

        currentLogs = allLogs.filter(log => {
            let isMatch = true;

            // 1. Âà©Áî®ËÄÖIDÊ§úÁ¥¢
            if (searchTerm && !log.user_id.toLowerCase().includes(searchTerm)) {
                isMatch = false;
            }

            // 2. Êó•ÊôÇ„Éï„Ç£„É´„Çø
            if (dateValue && isMatch) {
                const logDateStr = log.timestamp.substring(0, 10); 
                
                if (logDateStr !== dateValue) {
                    isMatch = false;
                } else {
                    const logTime = log.dateTime.getHours() * 60 + log.dateTime.getMinutes(); 
                    
                    // ÈñãÂßãÊôÇÂàª
                    if (startTimeValue) {
                        const [startH, startM] = startTimeValue.split(':').map(Number);
                        const startTime = startH * 60 + startM;
                        if (logTime < startTime) {
                            isMatch = false;
                        }
                    }

                    // ÁµÇ‰∫ÜÊôÇÂàª
                    if (endTimeValue && isMatch) {
                        const [endH, endM] = endTimeValue.split(':').map(Number);
                        const endTime = endH * 60 + endM;
                        if (logTime > endTime) {
                            isMatch = false;
                        }
                    }
                }
            }
            
            return isMatch;
        });

        currentPage = 1;
        document.getElementById('totalCount').textContent = `Ë©≤ÂΩì‰ª∂Êï∞: ${currentLogs.length} ‰ª∂`;
        renderList();
        renderPagination();
    }
    
    // ===================================================
    // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„Å®„É™„Çπ„ÉàË°®Á§∫ 
    // ===================================================
    
    function renderList() {
        const container = document.getElementById('tableContainer');
        container.innerHTML = "";
        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
              <tr>
                <th>Êó•ÊôÇ</th>
                <th>Âà©Áî®ËÄÖID</th>
                <th>Êìç‰ΩúÂÜÖÂÆπ</th>
              </tr>
            </thead>
          `;

          const tbody = document.createElement('tbody');
          if (currentLogs.length === 0) {
            tbody.innerHTML = `<tr class="no-data"><td colspan="3">Ë©≤ÂΩì„Åô„Çã„É≠„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>`;
          } else {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = currentLogs.slice(startIndex, endIndex);

            pageData.forEach(log => {
              const tr = document.createElement('tr');
              const localDateTime = log.dateTime.toLocaleString('ja-JP', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
              });
              
              // üí° Êìç‰ΩúÂÜÖÂÆπ„ÇíÊó•Êú¨Ë™û„Å´Â§âÊèõ
              const actionDisplay = log.action === 'login' ? '„É≠„Ç∞„Ç§„É≥' : '„É≠„Ç∞„Ç¢„Ç¶„Éà';
              
              tr.innerHTML = `<td>${localDateTime}</td><td>${log.user_id}</td><td>${actionDisplay}</td>`;
              tbody.appendChild(tr);
            });
          }

          table.appendChild(tbody);
          container.appendChild(table);
    }
    
    function renderPagination() {
        const container = document.getElementById('paginationContainer');
        container.innerHTML = "";
        const totalPages = Math.ceil(currentLogs.length / itemsPerPage);
        if (totalPages <= 1) return;
        const createButton = (text, page, isDisabled = false, isActive = false) => {
            const btn = document.createElement('button');
            btn.innerHTML = text;
            if (isDisabled) btn.classList.add('disabled');
            if (isActive) btn.classList.add('active');
            if (!isDisabled) btn.onclick = () => changePage(page);
            return btn;
        };

        const maxPagesToShow = 5; 
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        container.appendChild(createButton('‚Äπ', 'prev', currentPage === 1));

        if (startPage > 1) {
            container.appendChild(createButton(1, 1, false, currentPage === 1));
            if (startPage > 2) {
                const span = document.createElement('span');
                span.textContent = '...';
                container.appendChild(span);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            container.appendChild(createButton(i, i, false, currentPage === i));
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const span = document.createElement('span');
                span.textContent = '...';
                container.appendChild(span);
            }
            container.appendChild(createButton(totalPages, totalPages, false, currentPage === totalPages));
        }
        
        container.appendChild(createButton('‚Ä∫', 'next', currentPage === totalPages));
    }
    
    function changePage(page) {
        const totalPages = Math.ceil(currentLogs.length / itemsPerPage);
        if (page === 'prev' && currentPage > 1) currentPage--;
        else if (page === 'next' && currentPage < totalPages) currentPage++;
        else if (typeof page === 'number') currentPage = page;

        renderList();
        renderPagination();
    }
    
    // „É°„Éã„É•„Éº/„É≠„Ç∞„Ç¢„Ç¶„ÉàÈñ¢Êï∞ (Â§âÊõ¥„Å™„Åó)
    function toggleMenu(icon) {
        icon.classList.toggle('active');
        const menu = document.getElementById('menu');
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    }
    function logout() {
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ„ÅÆURL„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
        window.location.href = "{% url 'accounts:logout' %}"; 
    }
 </script>
</body>
</html>